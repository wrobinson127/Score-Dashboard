<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Scores Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 20px;
            font-weight: 700;
            color: #10b981;
        }

        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            justify-content: center;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 2px solid #333;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #555;
            background: #222;
        }

        .filter-btn.active {
            background: #10b981;
            border-color: #10b981;
        }

        .soccer-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #333;
            justify-content: center;
        }

        .soccer-filter-btn {
            padding: 8px 16px;
            background: #0a0a0a;
            border: 1px solid #333;
            color: #aaa;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .soccer-filter-btn:hover {
            border-color: #555;
            background: #1a1a1a;
            color: #fff;
        }

        .soccer-filter-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: #fff;
        }

        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .settings-modal.open {
            display: flex;
        }

        .settings-content {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .settings-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            color: #fff;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
            color: #aaa;
        }

        .settings-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 8px;
            background: #0a0a0a;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .settings-option.indented {
            margin-left: 30px;
            padding: 8px;
            background: #050505;
        }

        .settings-option:hover {
            background: #111;
        }

        .settings-option.indented:hover {
            background: #0a0a0a;
        }

        .settings-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            flex: 1;
            font-size: 0.95em;
        }

        .settings-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .settings-option input[type="number"] {
            width: 80px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.3em;
            transition: all 0.2s;
            z-index: 1001;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-toggle:hover {
            background: #222;
            border-color: #555;
        }

        .settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #aaa;
        }

        .settings input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .settings input[type="number"] {
            width: 80px;
            padding: 6px;
            background: #0a0a0a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 4px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .game-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .game-card:hover {
            border-color: #555;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .game-card.pinned {
            background: #1a2e1a;
            border-color: #4ade80;
        }

        .game-card.pinned:hover {
            border-color: #6ee7a0;
        }

        .game-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .game-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sport-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9em;
            color: #888;
            font-weight: 600;
        }

        .sport-icon {
            font-size: 1.2em;
        }

        .game-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-live {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-scheduled {
            background: #333;
            color: #aaa;
        }

        .status-final {
            background: #666;
            color: #fff;
        }

        .teams {
            margin: 15px 0;
        }

        .team-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2a2a2a;
        }

        .team-row:last-child {
            border-bottom: none;
        }

        .team-name {
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .team-name.has-possession {
            color: #fbbf24;
            font-weight: 700;
        }

        .team-name.has-possession::before {
            content: 'üèà ';
            font-size: 0.9em;
        }

        .team-score {
            font-size: 1.4em;
            font-weight: 700;
            min-width: 40px;
            text-align: right;
            transition: all 0.3s;
        }

        .score-flash {
            animation: scoreFlash 1.5s ease-out;
        }

        @keyframes scoreFlash {
            0% {
                background: #10b981;
                transform: scale(1.2);
                box-shadow: 0 0 20px #10b981;
            }
            50% {
                background: #10b981;
            }
            100% {
                background: transparent;
                transform: scale(1);
                box-shadow: none;
            }
        }

        .winning {
            color: #10b981;
        }

        .game-time {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #2a2a2a;
        }

        .last-update {
            text-align: center;
            color: #666;
            font-size: 0.85em;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .refreshing {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #666;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .refreshing.hidden {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            grid-column: 1 / -1;
            text-align: center;
            color: #888;
            padding: 40px;
            font-size: 1.1em;
        }

        .error {
            background: #991b1b;
            border: 1px solid #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÜ Live Scores Dashboard</h1>
            
            <div class="filters">
                <button class="filter-btn active" data-view="all">All Sports</button>
                <button class="filter-btn" data-view="pinned">üìå My Games</button>
                <button class="filter-btn" data-sport="NFL">üèà NFL</button>
                <button class="filter-btn" data-sport="NBA">üèÄ NBA</button>
                <button class="filter-btn" data-sport="NHL">üèí NHL</button>
                <button class="filter-btn" data-sport="MLB">‚öæ MLB</button>
                <button class="filter-btn" data-sport="Soccer">‚öΩ Soccer</button>
            </div>

            <!-- Soccer sub-tabs (hidden by default) -->
            <div class="soccer-filters" id="soccerFilters" style="display: none;">
                <button class="soccer-filter-btn active" data-league="all">All Leagues</button>
                <button class="soccer-filter-btn" data-league="UCL">üèÜ UCL</button>
                <button class="soccer-filter-btn" data-league="EPL">EPL</button>
                <button class="soccer-filter-btn" data-league="La Liga">La Liga</button>
                <button class="soccer-filter-btn" data-league="Serie A">Serie A</button>
                <button class="soccer-filter-btn" data-league="Bundesliga">Bundesliga</button>
                <button class="soccer-filter-btn" data-league="MLS">MLS</button>
                <button class="soccer-filter-btn" data-league="Saudi Pro League">Saudi Pro</button>
            </div>
        </header>

        <div id="error-container"></div>
        <div class="games-grid" id="gamesGrid">
            <div class="loading">Loading scores...</div>
        </div>

        <div class="last-update" id="lastUpdate"></div>
    </div>

    <!-- Settings toggle button -->
    <button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</button>

    <!-- Settings modal -->
    <div class="settings-modal" id="settingsModal" onclick="closeSettingsOnBackdrop(event)">
        <div class="settings-content" onclick="event.stopPropagation()">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="toggleSettings()">√ó</button>
            </div>

            <div class="settings-section">
                <h3>Auto-Refresh</h3>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="autoRefresh" checked>
                        Enable auto-refresh
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        Refresh interval (seconds):
                        <input type="number" id="refreshInterval" value="1" min="1" max="10" step="0.5">
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showSpinner" checked>
                        Show refresh spinner
                    </label>
                </div>
            </div>

            <div class="settings-section">
                <h3>Visible Sports</h3>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showNFL" checked>
                        üèà NFL
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showNBA" checked>
                        üèÄ NBA
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showNHL" checked>
                        üèí NHL
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showMLB" checked>
                        ‚öæ MLB
                    </label>
                </div>
                <div class="settings-option">
                    <label>
                        <input type="checkbox" id="showSoccer" checked>
                        ‚öΩ Soccer (All Leagues)
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showUCL" checked>
                        üèÜ Champions League
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showEPL" checked>
                        ‚öΩ EPL
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showLaLiga" checked>
                        ‚öΩ La Liga
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showSerieA" checked>
                        ‚öΩ Serie A
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showBundesliga" checked>
                        ‚öΩ Bundesliga
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showMLS" checked>
                        ‚öΩ MLS
                    </label>
                </div>
                <div class="settings-option indented">
                    <label>
                        <input type="checkbox" id="showSaudiProLeague" checked>
                        ‚öΩ Saudi Pro League
                    </label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let currentSport = 'all';
        let currentView = 'all'; // 'all' or 'pinned'
        let currentLeague = 'all'; // For soccer sub-filtering
        let pinnedGames = new Set(JSON.parse(localStorage.getItem('pinnedGames') || '[]'));
        let refreshTimer = null;
        let previousScores = new Map(); // Track previous scores to detect changes
        let allGames = []; // Store all fetched games
        let lastRenderedGameIds = ''; // Track which games were last rendered

        // ESPN API endpoints - always use our proxy
        const ESPN_APIS = {
            'NFL': '/api/nfl',
            'NBA': '/api/nba',
            'NHL': '/api/nhl',
            'MLB': '/api/mlb',
            'EPL': '/api/epl',
            'La Liga': '/api/laliga',
            'Serie A': '/api/seriea',
            'Bundesliga': '/api/bundesliga',
            'MLS': '/api/mls',
            'Saudi Pro League': '/api/saudileague',
            'UCL': '/api/ucl'
        };

        async function fetchScoresFromESPN() {
            // Show refreshing indicator only if enabled
            const lastUpdate = document.getElementById('lastUpdate');
            const showSpinner = localStorage.getItem('showSpinner') !== 'false';
            
            if (showSpinner) {
                lastUpdate.innerHTML = '<span class="refreshing"></span> Refreshing...';
            }
            
            // Clear games array
            const tempGames = [];
            
            try {
                console.log('Fetching scores from ESPN...');
                
                // Add cache-busting timestamp
                const cacheBuster = Date.now();
                
                // Fetch all sports in parallel
                const promises = Object.entries(ESPN_APIS).map(async ([sport, url]) => {
                    try {
                        // Add timestamp to prevent caching
                        const urlWithCache = url + '?_t=' + cacheBuster;
                        console.log(`Fetching ${sport} from: ${urlWithCache}`);
                        const response = await fetch(urlWithCache, {
                            cache: 'no-store',
                            headers: {
                                'Cache-Control': 'no-cache'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log(`${sport} data received:`, data);
                        return { sport, data };
                    } catch (error) {
                        console.error(`Error fetching ${sport}:`, error);
                        showError(`Failed to fetch ${sport} scores: ${error.message}`);
                        return { sport, data: null };
                    }
                });
                
                const results = await Promise.all(promises);
                
                // Parse each sport's data into temp array
                results.forEach(({ sport, data }) => {
                    if (data && data.events) {
                        console.log(`${sport} has ${data.events.length} events`);
                        data.events.forEach(event => {
                            const game = parseESPNGame(event, sport);
                            if (game) {
                                tempGames.push(game);
                                console.log('Added game:', game);
                            }
                        });
                    }
                });
                
                console.log(`Total games loaded: ${tempGames.length}`);
                
                // Replace allGames with new data
                allGames = tempGames;
                
                if (allGames.length === 0) {
                    showError('No games found. There may not be any games scheduled right now.');
                }
                
                renderGames();
                updateLastRefreshTime();
                
            } catch (error) {
                console.error('Error fetching scores:', error);
                showError('Failed to fetch live scores: ' + error.message);
                updateLastRefreshTime();
            }
        }

        function parseESPNGame(event, sport) {
            try {
                const competition = event.competitions[0];
                const status = event.status;
                
                // Get teams
                const homeTeam = competition.competitors.find(c => c.homeAway === 'home');
                const awayTeam = competition.competitors.find(c => c.homeAway === 'away');
                
                if (!homeTeam || !awayTeam) return null;
                
                // Determine game status
                let gameStatus = 'scheduled';
                if (status.type.completed) {
                    gameStatus = 'final';
                } else if (status.type.state === 'in') {
                    gameStatus = 'live';
                }
                
                // Get quarter/period info
                let quarter = status.type.shortDetail || status.type.detail;
                let time = '';
                
                if (gameStatus === 'live') {
                    quarter = status.period ? `Q${status.period}` : status.type.shortDetail;
                    time = status.displayClock || '';
                } else if (gameStatus === 'scheduled') {
                    quarter = new Date(event.date).toLocaleDateString('en-US', { weekday: 'short' });
                    time = new Date(event.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                }
                
                // For soccer leagues, adjust period display
                const soccerLeagues = ['EPL', 'La Liga', 'Serie A', 'Bundesliga', 'MLS', 'Saudi Pro League', 'UCL'];
                if (soccerLeagues.includes(sport) && gameStatus === 'live') {
                    if (status.period === 1) quarter = '1st Half';
                    else if (status.period === 2) quarter = '2nd Half';
                }
                
                // Get possession for NFL
                let possession = null;
                if (sport === 'NFL' && gameStatus === 'live' && competition.situation) {
                    const possessionTeamId = competition.situation.possession;
                    if (possessionTeamId === homeTeam.id) possession = 'home';
                    else if (possessionTeamId === awayTeam.id) possession = 'away';
                }
                
                return {
                    id: event.id,
                    sport: sport,
                    homeTeam: homeTeam.team.shortDisplayName || homeTeam.team.displayName,
                    awayTeam: awayTeam.team.shortDisplayName || awayTeam.team.displayName,
                    homeScore: parseInt(homeTeam.score) || 0,
                    awayScore: parseInt(awayTeam.score) || 0,
                    status: gameStatus,
                    quarter: quarter,
                    time: time,
                    possession: possession
                };
                
            } catch (error) {
                console.error('Error parsing game:', error);
                return null;
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                errorContainer.innerHTML = '';
            }, 10000); // Show for 10 seconds
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Hide/show soccer filters
                const soccerFilters = document.getElementById('soccerFilters');
                
                if (btn.dataset.view) {
                    currentView = btn.dataset.view;
                    currentSport = 'all';
                    soccerFilters.style.display = 'none';
                } else if (btn.dataset.sport) {
                    currentView = 'all';
                    currentSport = btn.dataset.sport;
                    
                    // Show soccer sub-tabs if Soccer is selected
                    if (currentSport === 'Soccer') {
                        soccerFilters.style.display = 'flex';
                        currentLeague = 'all'; // Reset to all leagues
                        document.querySelectorAll('.soccer-filter-btn').forEach(b => b.classList.remove('active'));
                        document.querySelector('.soccer-filter-btn[data-league="all"]').classList.add('active');
                    } else {
                        soccerFilters.style.display = 'none';
                    }
                }
                
                renderGames();
            });
        });

        // Soccer league filter buttons
        document.querySelectorAll('.soccer-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.soccer-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentLeague = btn.dataset.league;
                renderGames();
            });
        });

        // Auto-refresh toggle
        document.getElementById('autoRefresh').addEventListener('change', (e) => {
            if (e.target.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // Refresh interval change
        document.getElementById('refreshInterval').addEventListener('change', () => {
            if (document.getElementById('autoRefresh').checked) {
                stopAutoRefresh();
                startAutoRefresh();
            }
        });

        function togglePin(gameId, event) {
            // Stop event from bubbling if needed
            if (event) {
                event.stopPropagation();
            }
            
            // Toggle pin state
            if (pinnedGames.has(gameId)) {
                pinnedGames.delete(gameId);
            } else {
                pinnedGames.add(gameId);
            }
            localStorage.setItem('pinnedGames', JSON.stringify([...pinnedGames]));
            
            // Immediately update the card's visual state
            const card = document.querySelector(`[data-game-id="${gameId}"]`);
            if (card) {
                if (pinnedGames.has(gameId)) {
                    card.classList.add('pinned');
                } else {
                    card.classList.remove('pinned');
                }
            }
            
            // Re-render to update tabs
            renderGames();
        }
        
        // Make togglePin globally accessible
        window.togglePin = togglePin;

        function renderGames() {
            const grid = document.getElementById('gamesGrid');
            
            let games = allGames;
            
            // Filter by sport visibility settings
            games = games.filter(g => visibleSports[g.sport]);
            
            // Filter by view (all or pinned)
            if (currentView === 'pinned') {
                games = games.filter(g => pinnedGames.has(g.id));
            }
            
            // Filter by sport
            if (currentSport !== 'all' && currentView !== 'pinned') {
                if (currentSport === 'Soccer') {
                    // Filter to show all soccer leagues
                    const soccerLeagues = ['EPL', 'La Liga', 'Serie A', 'Bundesliga', 'MLS', 'Saudi Pro League', 'UCL'];
                    games = games.filter(g => soccerLeagues.includes(g.sport));
                    
                    // Further filter by specific league if selected
                    if (currentLeague !== 'all') {
                        games = games.filter(g => g.sport === currentLeague);
                    }
                } else {
                    games = games.filter(g => g.sport === currentSport);
                }
            }
            
            // Sort games: Live first, then scheduled, then final
            games.sort((a, b) => {
                const statusOrder = { 'live': 0, 'scheduled': 1, 'final': 2 };
                return statusOrder[a.status] - statusOrder[b.status];
            });
            
            if (games.length === 0) {
                let message = 'No games to display';
                
                if (currentView === 'pinned') {
                    message = 'No pinned games. Click any game card to track it here.';
                } else if (currentSport !== 'all') {
                    // Sport-specific date range messages
                    const dateRanges = {
                        'NFL': '7 days',
                        'NBA': '2 days',
                        'NHL': '2 days',
                        'MLB': '2 days',
                        'Soccer': '3 days'
                    };
                    
                    const days = dateRanges[currentSport] || '2 days';
                    
                    if (currentSport === 'Soccer' && currentLeague !== 'all') {
                        message = `No ${currentLeague} games in the next ${days}. Check back later!`;
                    } else {
                        message = `No ${currentSport} games in the next ${days}. Check back later!`;
                    }
                }
                
                grid.innerHTML = `<div class="loading">${message}</div>`;
                lastRenderedGameIds = '';
                return;
            }
            
            // Check if the list of games has changed
            const currentGameIds = games.map(g => `${g.id}-${g.status}`).join(',');
            const gamesListChanged = currentGameIds !== lastRenderedGameIds;
            
            console.log('Games list changed:', gamesListChanged);
            
            if (gamesListChanged) {
                console.log('Full rebuild - games changed');
                // Full rebuild - games list changed
                buildFullGamesList(games, grid);
                lastRenderedGameIds = currentGameIds;
            } else {
                console.log('Quick update - just updating scores');
                // Just update scores/times for existing games
                updateExistingGames(games);
            }
        }
        
        function buildFullGamesList(games, grid) {
            // Group games by status
            const liveGames = games.filter(g => g.status === 'live');
            const scheduledGames = games.filter(g => g.status === 'scheduled');
            const finalGames = games.filter(g => g.status === 'final');
            
            let html = '';
            
            // Add live games section
            if (liveGames.length > 0) {
                html += '<div style="grid-column: 1 / -1; font-size: 1.2em; font-weight: 700; margin: 10px 0; color: #ef4444;">‚óè LIVE GAMES</div>';
                html += liveGames.map(game => renderGameCard(game)).join('');
            }
            
            // Add scheduled games section
            if (scheduledGames.length > 0) {
                html += '<div style="grid-column: 1 / -1; font-size: 1.2em; font-weight: 700; margin: 20px 0 10px 0; color: #888;">UPCOMING GAMES</div>';
                html += scheduledGames.map(game => renderGameCard(game)).join('');
            }
            
            // Add final games section
            if (finalGames.length > 0) {
                html += '<div style="grid-column: 1 / -1; font-size: 1.2em; font-weight: 700; margin: 20px 0 10px 0; color: #666;">FINAL GAMES</div>';
                html += finalGames.map(game => renderGameCard(game)).join('');
            }
            
            grid.innerHTML = html;
        }
        
        function updateExistingGames(games) {
            games.forEach(game => {
                // Find the game card by data attribute
                const card = document.querySelector(`[data-game-id="${game.id}"]`);
                if (!card) return;
                
                const scores = card.querySelectorAll('.team-score');
                const timeDisplay = card.querySelector('.game-time');
                
                if (scores.length === 2) {
                    // Check away score
                    const previousScore = previousScores.get(game.id);
                    
                    // Update away score
                    if (scores[0].textContent != game.awayScore) {
                        scores[0].textContent = game.awayScore;
                        if (previousScore && game.awayScore > previousScore.awayScore) {
                            scores[0].classList.add('score-flash');
                            setTimeout(() => scores[0].classList.remove('score-flash'), 1500);
                        }
                    }
                    
                    // Update home score  
                    if (scores[1].textContent != game.homeScore) {
                        scores[1].textContent = game.homeScore;
                        if (previousScore && game.homeScore > previousScore.homeScore) {
                            scores[1].classList.add('score-flash');
                            setTimeout(() => scores[1].classList.remove('score-flash'), 1500);
                        }
                    }
                    
                    // Update previous scores
                    previousScores.set(game.id, {
                        homeScore: game.homeScore,
                        awayScore: game.awayScore
                    });
                }
                
                // Update time/quarter
                if (timeDisplay) {
                    timeDisplay.textContent = `${game.quarter} - ${game.time}`;
                }
            });
        }
        
        function renderGameCard(game) {
            const sportIcons = {
                'NFL': 'üèà',
                'NBA': 'üèÄ',
                'NHL': 'üèí',
                'MLB': '‚öæ',
                'EPL': '‚öΩ',
                'La Liga': '‚öΩ',
                'Serie A': '‚öΩ',
                'Bundesliga': '‚öΩ',
                'MLS': '‚öΩ',
                'Saudi Pro League': '‚öΩ',
                'UCL': 'üèÜ'
            };
            
            const statusClass = `status-${game.status}`;
            const homeWinning = game.homeScore > game.awayScore;
            const awayWinning = game.awayScore > game.homeScore;
            const isPinned = pinnedGames.has(game.id);
            
            // Check possession for NFL games
            const homePossession = game.sport === 'NFL' && game.possession === 'home';
            const awayPossession = game.sport === 'NFL' && game.possession === 'away';
            
            // Check if score changed
            const previousScore = previousScores.get(game.id);
            let homeScoreChanged = false;
            let awayScoreChanged = false;
            
            if (previousScore && game.status === 'live') {
                homeScoreChanged = game.homeScore > previousScore.homeScore;
                awayScoreChanged = game.awayScore > previousScore.awayScore;
            }
            
            // Update previous scores
            previousScores.set(game.id, {
                homeScore: game.homeScore,
                awayScore: game.awayScore
            });
            
            return `
                <div class="game-card ${isPinned ? 'pinned' : ''}" data-game-id="${game.id}" onclick="window.togglePin('${game.id}', event)">
                    <div class="game-header">
                        <div class="game-header-left">
                            <div class="sport-badge">
                                <span class="sport-icon">${sportIcons[game.sport]}</span>
                                <span>${game.sport}</span>
                            </div>
                        </div>
                        <div class="game-status ${statusClass}">
                            ${game.status === 'live' ? '‚óè LIVE' : game.status.toUpperCase()}
                        </div>
                    </div>
                    
                    <div class="teams">
                        <div class="team-row">
                            <div class="team-name ${awayPossession ? 'has-possession' : ''}">${game.awayTeam}</div>
                            <div class="team-score ${awayWinning ? 'winning' : ''} ${awayScoreChanged ? 'score-flash' : ''}">${game.awayScore}</div>
                        </div>
                        <div class="team-row">
                            <div class="team-name ${homePossession ? 'has-possession' : ''}">${game.homeTeam}</div>
                            <div class="team-score ${homeWinning ? 'winning' : ''} ${homeScoreChanged ? 'score-flash' : ''}">${game.homeScore}</div>
                        </div>
                    </div>
                    
                    <div class="game-time">
                        ${game.quarter} - ${game.time}
                    </div>
                </div>
            `;
        }

        function updateLastRefreshTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('lastUpdate').textContent = `Last updated: ${timeString}`;
        }

        function fetchScores() {
            fetchScoresFromESPN();
        }

        function startAutoRefresh() {
            const interval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            console.log(`Starting auto-refresh with ${interval}ms interval`);
            refreshTimer = setInterval(() => {
                console.log('Auto-refresh triggered at', new Date().toLocaleTimeString());
                fetchScores();
            }, interval);
        }

        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
            }
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
        }

        function closeSettingsOnBackdrop(event) {
            if (event.target.id === 'settingsModal') {
                toggleSettings();
            }
        }

        // Load sport visibility settings
        let visibleSports = {
            NFL: localStorage.getItem('showNFL') !== 'false',
            NBA: localStorage.getItem('showNBA') !== 'false',
            NHL: localStorage.getItem('showNHL') !== 'false',
            MLB: localStorage.getItem('showMLB') !== 'false',
            EPL: localStorage.getItem('showEPL') !== 'false',
            'La Liga': localStorage.getItem('showLaLiga') !== 'false',
            'Serie A': localStorage.getItem('showSerieA') !== 'false',
            Bundesliga: localStorage.getItem('showBundesliga') !== 'false',
            MLS: localStorage.getItem('showMLS') !== 'false',
            'Saudi Pro League': localStorage.getItem('showSaudiProLeague') !== 'false',
            UCL: localStorage.getItem('showUCL') !== 'false'
        };

        // Set initial checkbox states and add event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Set checkbox states
            document.getElementById('showNFL').checked = visibleSports.NFL;
            document.getElementById('showNBA').checked = visibleSports.NBA;
            document.getElementById('showNHL').checked = visibleSports.NHL;
            document.getElementById('showMLB').checked = visibleSports.MLB;
            
            // Soccer master checkbox - check if any soccer league is visible
            const anySoccerVisible = visibleSports.EPL || visibleSports['La Liga'] || visibleSports['Serie A'] || 
                                     visibleSports.Bundesliga || visibleSports.MLS || visibleSports['Saudi Pro League'] || visibleSports.UCL;
            document.getElementById('showSoccer').checked = anySoccerVisible;
            
            document.getElementById('showEPL').checked = visibleSports.EPL;
            document.getElementById('showLaLiga').checked = visibleSports['La Liga'];
            document.getElementById('showSerieA').checked = visibleSports['Serie A'];
            document.getElementById('showBundesliga').checked = visibleSports.Bundesliga;
            document.getElementById('showMLS').checked = visibleSports.MLS;
            document.getElementById('showSaudiProLeague').checked = visibleSports['Saudi Pro League'];
            document.getElementById('showUCL').checked = visibleSports.UCL;
            document.getElementById('showSpinner').checked = localStorage.getItem('showSpinner') !== 'false';

            // Add event listener for spinner toggle
            document.getElementById('showSpinner').addEventListener('change', (e) => {
                localStorage.setItem('showSpinner', e.target.checked);
            });

            // Soccer master toggle - toggles all soccer leagues
            document.getElementById('showSoccer').addEventListener('change', (e) => {
                const checked = e.target.checked;
                visibleSports.EPL = checked;
                visibleSports['La Liga'] = checked;
                visibleSports['Serie A'] = checked;
                visibleSports.Bundesliga = checked;
                visibleSports.MLS = checked;
                visibleSports['Saudi Pro League'] = checked;
                visibleSports.UCL = checked;
                
                localStorage.setItem('showEPL', checked);
                localStorage.setItem('showLaLiga', checked);
                localStorage.setItem('showSerieA', checked);
                localStorage.setItem('showBundesliga', checked);
                localStorage.setItem('showMLS', checked);
                localStorage.setItem('showSaudiProLeague', checked);
                localStorage.setItem('showUCL', checked);
                
                document.getElementById('showEPL').checked = checked;
                document.getElementById('showLaLiga').checked = checked;
                document.getElementById('showSerieA').checked = checked;
                document.getElementById('showBundesliga').checked = checked;
                document.getElementById('showMLS').checked = checked;
                document.getElementById('showSaudiProLeague').checked = checked;
                document.getElementById('showUCL').checked = checked;
                
                updateTabVisibility();
                renderGames();
            });

            // Helper function to update tab visibility
            const updateTabVisibility = () => {
                const nflTab = document.querySelector('[data-sport="NFL"]');
                const nbaTab = document.querySelector('[data-sport="NBA"]');
                const nhlTab = document.querySelector('[data-sport="NHL"]');
                const mlbTab = document.querySelector('[data-sport="MLB"]');
                const soccerTab = document.querySelector('[data-sport="Soccer"]');
                
                if (nflTab) nflTab.style.display = visibleSports.NFL ? '' : 'none';
                if (nbaTab) nbaTab.style.display = visibleSports.NBA ? '' : 'none';
                if (nhlTab) nhlTab.style.display = visibleSports.NHL ? '' : 'none';
                if (mlbTab) mlbTab.style.display = visibleSports.MLB ? '' : 'none';
                
                // Soccer tab is visible if any soccer league is enabled
                const anySoccerVisible = visibleSports.EPL || visibleSports['La Liga'] || visibleSports['Serie A'] || 
                                         visibleSports.Bundesliga || visibleSports.MLS || visibleSports['Saudi Pro League'] || visibleSports.UCL;
                if (soccerTab) soccerTab.style.display = anySoccerVisible ? '' : 'none';
                
                // Update soccer sub-tab visibility
                const uclSubTab = document.querySelector('[data-league="UCL"]');
                const eplSubTab = document.querySelector('[data-league="EPL"]');
                const laligaSubTab = document.querySelector('[data-league="La Liga"]');
                const serieaSubTab = document.querySelector('[data-league="Serie A"]');
                const bundesligaSubTab = document.querySelector('[data-league="Bundesliga"]');
                const mlsSubTab = document.querySelector('[data-league="MLS"]');
                const saudiSubTab = document.querySelector('[data-league="Saudi Pro League"]');
                
                if (uclSubTab) uclSubTab.style.display = visibleSports.UCL ? '' : 'none';
                if (eplSubTab) eplSubTab.style.display = visibleSports.EPL ? '' : 'none';
                if (laligaSubTab) laligaSubTab.style.display = visibleSports['La Liga'] ? '' : 'none';
                if (serieaSubTab) serieaSubTab.style.display = visibleSports['Serie A'] ? '' : 'none';
                if (bundesligaSubTab) bundesligaSubTab.style.display = visibleSports.Bundesliga ? '' : 'none';
                if (mlsSubTab) mlsSubTab.style.display = visibleSports.MLS ? '' : 'none';
                if (saudiSubTab) saudiSubTab.style.display = visibleSports['Saudi Pro League'] ? '' : 'none';
            };

            // Helper function to create visibility toggle listener
            const createToggleListener = (id, sportKey, storageKey) => {
                document.getElementById(id).addEventListener('change', (e) => {
                    visibleSports[sportKey] = e.target.checked;
                    localStorage.setItem(storageKey, e.target.checked);
                    updateTabVisibility();
                    renderGames();
                });
            };

            // Add event listeners for all sports
            createToggleListener('showNFL', 'NFL', 'showNFL');
            createToggleListener('showNBA', 'NBA', 'showNBA');
            createToggleListener('showNHL', 'NHL', 'showNHL');
            createToggleListener('showMLB', 'MLB', 'showMLB');
            createToggleListener('showEPL', 'EPL', 'showEPL');
            createToggleListener('showLaLiga', 'La Liga', 'showLaLiga');
            createToggleListener('showSerieA', 'Serie A', 'showSerieA');
            createToggleListener('showBundesliga', 'Bundesliga', 'showBundesliga');
            createToggleListener('showMLS', 'MLS', 'showMLS');
            createToggleListener('showSaudiProLeague', 'Saudi Pro League', 'showSaudiProLeague');
            createToggleListener('showUCL', 'UCL', 'showUCL');
            
            // Initial tab visibility update
            updateTabVisibility();
        });

        // Initial load
        fetchScores();
        startAutoRefresh();
    </script>
</body>
</html>
